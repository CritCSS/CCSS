<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="">

<title>Tidyverse + Dataviz</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Tidyverse + Dataviz</li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">about</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../contributors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contributors</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#complex-data-wrangling-with-tidyverse" id="toc-complex-data-wrangling-with-tidyverse" class="nav-link active" data-scroll-target="#complex-data-wrangling-with-tidyverse">Complex data wrangling with Tidyverse</a>
  <ul class="collapse">
  <li><a href="#importing-the-dataset-covid-19-in-usa" id="toc-importing-the-dataset-covid-19-in-usa" class="nav-link" data-scroll-target="#importing-the-dataset-covid-19-in-usa">Importing the dataset: COVID-19 in USA</a></li>
  <li><a href="#lets-get-tidy" id="toc-lets-get-tidy" class="nav-link" data-scroll-target="#lets-get-tidy">Let’s get Tidy</a>
  <ul class="collapse">
  <li><a href="#select" id="toc-select" class="nav-link" data-scroll-target="#select">select()</a></li>
  <li><a href="#lubridate" id="toc-lubridate" class="nav-link" data-scroll-target="#lubridate">lubridate</a></li>
  <li><a href="#quick-quality-check" id="toc-quick-quality-check" class="nav-link" data-scroll-target="#quick-quality-check">Quick quality check</a></li>
  </ul></li>
  <li><a href="#reshaping-and-summarizing-data" id="toc-reshaping-and-summarizing-data" class="nav-link" data-scroll-target="#reshaping-and-summarizing-data">Reshaping and summarizing data</a></li>
  <li><a href="#merging-data" id="toc-merging-data" class="nav-link" data-scroll-target="#merging-data">Merging data</a></li>
  <li><a href="#envisioning-information" id="toc-envisioning-information" class="nav-link" data-scroll-target="#envisioning-information">Envisioning information</a>
  <ul class="collapse">
  <li><a href="#the-basics-plot" id="toc-the-basics-plot" class="nav-link" data-scroll-target="#the-basics-plot">The basics: plot()</a></li>
  <li><a href="#reloaded-plots-with-ggplot" id="toc-reloaded-plots-with-ggplot" class="nav-link" data-scroll-target="#reloaded-plots-with-ggplot">Reloaded plots with ggplot</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tidyverse + Dataviz</h1>
<p class="subtitle lead">Guided practice</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="complex-data-wrangling-with-tidyverse" class="level1">
<h1>Complex data wrangling with Tidyverse</h1>
<section id="importing-the-dataset-covid-19-in-usa" class="level2">
<h2 class="anchored" data-anchor-id="importing-the-dataset-covid-19-in-usa">Importing the dataset: COVID-19 in USA</h2>
<p>In this guided practice, we will see how to make complex data transformations with tidyverse. We will work with the <a href="https://www.kaggle.com/datasets/sudalairajkumar/covid19-in-usa?select=us_counties_covid19_daily.csv">COVID-19 cases in USA dataset</a> at state level. First, let’s read the dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./data/asec/us_states_covid19_daily.csv"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15,633 × 55
       date state positive probableCases negative pending totalTestResultsSource
      &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;         &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;                 
 1 20201206 AK       35720            NA  1042056      NA totalTestsViral       
 2 20201206 AL      269877         45962  1421126      NA totalTestsPeopleViral 
 3 20201206 AR      170924         22753  1614979      NA totalTestsViral       
 4 20201206 AS           0            NA     2140      NA totalTestsViral       
 5 20201206 AZ      364276         12590  2018813      NA totalTestsPeopleViral 
 6 20201206 CA     1341700            NA 23853346      NA totalTestsViral       
 7 20201206 CO      260581         11069  1608829      NA totalTestEncountersVi…
 8 20201206 CT      127715          8131  3294383      NA posNeg                
 9 20201206 DC       23136            NA   711497      NA totalTestEncountersVi…
10 20201206 DE       39912          1550   400854      NA totalTestEncountersVi…
# ℹ 15,623 more rows
# ℹ 48 more variables: totalTestResults &lt;dbl&gt;, hospitalizedCurrently &lt;dbl&gt;,
#   hospitalizedCumulative &lt;dbl&gt;, inIcuCurrently &lt;dbl&gt;, inIcuCumulative &lt;dbl&gt;,
#   onVentilatorCurrently &lt;dbl&gt;, onVentilatorCumulative &lt;dbl&gt;, recovered &lt;dbl&gt;,
#   dataQualityGrade &lt;chr&gt;, lastUpdateEt &lt;chr&gt;, dateModified &lt;dttm&gt;,
#   checkTimeEt &lt;chr&gt;, death &lt;dbl&gt;, hospitalized &lt;dbl&gt;, dateChecked &lt;dttm&gt;,
#   totalTestsViral &lt;dbl&gt;, positiveTestsViral &lt;dbl&gt;, …</code></pre>
</div>
</div>
</section>
<section id="lets-get-tidy" class="level2">
<h2 class="anchored" data-anchor-id="lets-get-tidy">Let’s get Tidy</h2>
<section id="select" class="level3">
<h3 class="anchored" data-anchor-id="select">select()</h3>
<p>As we can see, it contains over 55 columns. Our first step will be to select some variables, the ones we want to work with. In this case, we have chosen date, state, positive, negative and probable cases, the test source and number of results, and the cumulative information in hospitals. We can do this with the function <code>select()</code>. We can simply use it writing the name of the variables we want manually, but we can also combine it with the renaming of variables and select variables that match a pattern.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, state, positive, </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">probable_cases =</span> probableCases, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                        negative, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">contains</span>(<span class="st">"totalTests"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, we renamed <code>probableCases</code> as <code>probable_cases</code> while we selected it into our new dataframe. We also introduced the verb <code>contains()</code>, which is a useful function to select variables that match a pattern. The complete list of verbs available are:</p>
<ul>
<li><p><code>starts_with()</code>: Starts with an exact prefix.</p></li>
<li><p><code>ends_with()</code>: Ends with an exact suffix.</p></li>
<li><p><code>contains()</code>: Contains a literal string.</p></li>
<li><p><code>matches()</code>: Matches a regular expression.</p></li>
<li><p><code>num_range(x, 1:3)</code>: Matches a numerical range like x1, x2, x3.</p></li>
</ul>
<p>These functions are what tidyverse calls <a href="https://tidyselect.r-lib.org/reference/language.html">selection helpers</a> for variables. We will return to them in different examples of this practice. For now, it is enough to know that these are a domain-specific language for selecting specific variables.</p>
</section>
<section id="lubridate" class="level3">
<h3 class="anchored" data-anchor-id="lubridate">lubridate</h3>
<p>Now, we want to transform the format of our variables. For example, <code>date</code> is stored as a numeric variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(data<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric"</code></pre>
</div>
</div>
<p>We want to transform it to a date format. We will import <code>lubridate</code> in order to do so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we need to parse<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> our date column with <code>lubridate</code> functions to correct it. To generate date objects, we can call a function using <code>y</code>, <code>m</code>, and <code>d</code> in the order in which the year (<code>y</code>), month (<code>m</code>), and date (<code>d</code>) appear in our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(date))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(data<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Date"</code></pre>
</div>
</div>
<p>This works for data in a numeric format, but also as strings!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Month-day-year </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mdy</span>(<span class="st">"March 28th, 2023"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2023-03-28"</code></pre>
</div>
</div>
<p>We could also be interested in creating columns extracting year, month and day in separate variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">month =</span> <span class="fu">month</span>(date),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">day =</span> <span class="fu">day</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>         year<span class="sc">:</span>day, </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>         state<span class="sc">:</span>totalTestsAntigen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15,633 × 14
   date        year month   day state positive probable_cases negative
   &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;    &lt;dbl&gt;          &lt;dbl&gt;    &lt;dbl&gt;
 1 2020-12-06  2020    12     6 AK       35720             NA  1042056
 2 2020-12-06  2020    12     6 AL      269877          45962  1421126
 3 2020-12-06  2020    12     6 AR      170924          22753  1614979
 4 2020-12-06  2020    12     6 AS           0             NA     2140
 5 2020-12-06  2020    12     6 AZ      364276          12590  2018813
 6 2020-12-06  2020    12     6 CA     1341700             NA 23853346
 7 2020-12-06  2020    12     6 CO      260581          11069  1608829
 8 2020-12-06  2020    12     6 CT      127715           8131  3294383
 9 2020-12-06  2020    12     6 DC       23136             NA   711497
10 2020-12-06  2020    12     6 DE       39912           1550   400854
# ℹ 15,623 more rows
# ℹ 6 more variables: totalTestsViral &lt;dbl&gt;, totalTestsPeopleViral &lt;dbl&gt;,
#   totalTestsAntibody &lt;dbl&gt;, totalTestsPeopleAntibody &lt;dbl&gt;,
#   totalTestsPeopleAntigen &lt;dbl&gt;, totalTestsAntigen &lt;dbl&gt;</code></pre>
</div>
</div>
<p>We created three new columns. But since they were added, by default, to the end of the dataframe, we also used the selection step to reorder the variables. We used the selection helper <code>:</code> to get an interval of columns. Writing <code>year:day</code> extracts all the columns year, day, and every other one between them. It is the same as writing <code>select(year, month, day)</code>, but saving up some lines of code. This is specially useful for when we want to select a large number of variables, like the ones between <code>state</code> and <code>totalTestResultsIncrease</code>.</p>
</section>
<section id="quick-quality-check" class="level3">
<h3 class="anchored" data-anchor-id="quick-quality-check">Quick quality check</h3>
<p>We are interested in knowing the number of different types of tests each state had. We have the information regarding the type of tests in the columns that start with <code>totalTests</code>.</p>
<ul>
<li><p><code>totalTestsViral</code>: Total number of <strong>PCR tests (or specimens tested)</strong> as reported by the state or territory.</p></li>
<li><p><code>totalTestsPeopleViral</code>: Total number of <strong>unique people tested at least once via PCR testing</strong>, as reported by the state or territory.</p></li>
<li><p><code>totalTestsAntibody:</code> Total number of <strong>completed antibody tests</strong> as reported by the state or territory.</p></li>
<li><p><code>totalTestsPeopleAntibody:</code>The total number of <strong>unique people who have been tested at least once via antibody testing</strong> as reported by the state or territory.</p></li>
<li><p><code>totalTestsAntigen:</code> Total number of <strong>completed antigen tests</strong>, as reported by the state or territory.</p></li>
<li><p><code>totalTestsPeopleAntigen:</code> Total number of <strong>unique people who have been tested at least once via antigen testing</strong>, as reported by the state or territory</p></li>
</ul>
<p>According to this documentation, the total number of tests should include the total number of people who were tested. However, some states didn’t register the information like so. Take for example Arizona:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"AZ"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 278 × 11
   date       state positive probable_cases negative totalTestsViral
   &lt;date&gt;     &lt;chr&gt;    &lt;dbl&gt;          &lt;dbl&gt;    &lt;dbl&gt;           &lt;dbl&gt;
 1 2020-12-06 AZ      364276          12590  2018813              NA
 2 2020-12-05 AZ      358900          12139  2003152              NA
 3 2020-12-04 AZ      352101          11634  1986277              NA
 4 2020-12-03 AZ      346421          11173  1969836              NA
 5 2020-12-02 AZ      340979          10662  1957887              NA
 6 2020-12-01 AZ      337139          10301  1945076              NA
 7 2020-11-30 AZ      326817          10077  1936949              NA
 8 2020-11-29 AZ      325995           9989  1920319              NA
 9 2020-11-28 AZ      322774           9909  1905019              NA
10 2020-11-27 AZ      318638           9772  1894651              NA
# ℹ 268 more rows
# ℹ 5 more variables: totalTestsPeopleViral &lt;dbl&gt;, totalTestsAntibody &lt;dbl&gt;,
#   totalTestsPeopleAntibody &lt;dbl&gt;, totalTestsPeopleAntigen &lt;dbl&gt;,
#   totalTestsAntigen &lt;dbl&gt;</code></pre>
</div>
</div>
<p>We see that they registered the number of total PCR tests in the column of total people who were tested. So in order to get the complete number of type of tests per state, without duplicating the values, we will make a conditional replacement of the column.</p>
<p>We are going to make use of the <strong>scoped</strong> variant of <code>mutate</code>, <code>mutate_at</code>, in order to change the values of multiple columns. Scoped variants of tidyverse verbs apply an expression (sometimes several) to all variables within a specified subset. This subset can contain:</p>
<ul>
<li><p>all variables (<code>_all</code> variants)</p></li>
<li><p>a <code>vars()</code>, selection of multiple variables of different type (<code>_at</code> variants)</p></li>
<li><p>or variables selected with a predicate (<code>_if</code> variants)</p></li>
</ul>
<p>When we use <code>mutate_at</code>, we must call the variables in a vars() argument, to indicate that we are selecting columns of the dataframe. Next, we will combine this with the function <code>case_when()</code>. <code>case_when()</code> allows us to vectorise multiple <code>if_else()</code> statements, where each case is evaluated sequentially and the first match for each element determines the corresponding value in the output vector.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vars</span>(totalTestsAntibody), <span class="sc">~</span><span class="fu">case_when</span>(<span class="fu">is.na</span>(.) <span class="sc">~</span> totalTestsPeopleAntibody,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="cn">TRUE</span> <span class="sc">~</span> .),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vars</span>(totalTestsViral), <span class="sc">~</span><span class="fu">case_when</span>(<span class="fu">is.na</span>(.) <span class="sc">~</span> totalTestsPeopleViral,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                                         <span class="cn">TRUE</span> <span class="sc">~</span> .),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vars</span>(totalTestsAntigen), <span class="sc">~</span><span class="fu">case_when</span>(<span class="fu">is.na</span>(.) <span class="sc">~</span> totalTestsPeopleAntigen,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                                         <span class="cn">TRUE</span> <span class="sc">~</span> .)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="reshaping-and-summarizing-data" class="level2">
<h2 class="anchored" data-anchor-id="reshaping-and-summarizing-data">Reshaping and summarizing data</h2>
<p>Now, we can use transformations to summarize and get aggregated information from our data. For example,</p>
<p>In order to get this information, we need to reshape our tidy, wide data into a long format. We will do this with the function <code>pivot_longer()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, state, <span class="fu">starts_with</span>(<span class="st">"totalTests"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"totalTests"</span>),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">names_to =</span> <span class="st">"type_test"</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">values_to =</span> <span class="st">"n"</span>) </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>test_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 93,798 × 4
   date       state type_test                      n
   &lt;date&gt;     &lt;chr&gt; &lt;chr&gt;                      &lt;dbl&gt;
 1 2020-12-06 AK    totalTestsViral          1077776
 2 2020-12-06 AK    totalTestsPeopleViral         NA
 3 2020-12-06 AK    totalTestsAntibody            NA
 4 2020-12-06 AK    totalTestsPeopleAntibody      NA
 5 2020-12-06 AK    totalTestsPeopleAntigen       NA
 6 2020-12-06 AK    totalTestsAntigen             NA
 7 2020-12-06 AL    totalTestsViral               NA
 8 2020-12-06 AL    totalTestsPeopleViral    1645041
 9 2020-12-06 AL    totalTestsAntibody         74784
10 2020-12-06 AL    totalTestsPeopleAntibody   74784
# ℹ 93,788 more rows</code></pre>
</div>
</div>
<p>Since the data about tested people is now in the <code>totalTests</code> types of variables, we can remove the rows that contain “totalTestsPeople” in their name.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> test_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(type_test, <span class="st">"totalTestsPeople"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before proceeding with the summary, we will rename our <code>type_test</code> variables to more comprehensible names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> test_data <span class="sc">%&gt;%</span> <span class="fu">mutate_at</span>(<span class="fu">vars</span>(type_test), </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">~</span><span class="fu">case_when</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                          . <span class="sc">==</span> <span class="st">"totalTestsViral"</span> <span class="sc">~</span> <span class="st">"PCR"</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                          . <span class="sc">==</span> <span class="st">"totalTestsAntibody"</span> <span class="sc">~</span> <span class="st">"Antibody"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                          . <span class="sc">==</span> <span class="st">"totalTestsAntigen"</span> <span class="sc">~</span> <span class="st">"Antigen"</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                        ))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>test_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 46,899 × 4
   date       state type_test       n
   &lt;date&gt;     &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;
 1 2020-12-06 AK    PCR       1077776
 2 2020-12-06 AK    Antibody       NA
 3 2020-12-06 AK    Antigen        NA
 4 2020-12-06 AL    PCR            NA
 5 2020-12-06 AL    Antibody    74784
 6 2020-12-06 AL    Antigen        NA
 7 2020-12-06 AR    PCR       1763150
 8 2020-12-06 AR    Antibody       NA
 9 2020-12-06 AR    Antigen     21856
10 2020-12-06 AS    PCR          2140
# ℹ 46,889 more rows</code></pre>
</div>
</div>
<p>Now we can group and count the number of tests per state. We will make use of two functions:</p>
<ul>
<li><p><code>group_by()</code>: we will pass the names of the variables we want to use as grouping criteria, in our case <code>state</code> and <code>type_test</code>.</p></li>
<li><p><code>summarise()</code>: this is a function that is used to compute summary statistics for a group of data. First, we need to set the name of the output variable. We will use <code>total_n</code>. Then, we need to apply the summary statistic we want to use. In our case, we want to get the <code>sum()</code> of the values in <code>n</code> for each group. Since our dataset has many NA values in the column we want to add, we will set the parameter <code>na.rm = TRUE</code>, so these values are removed.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>grouped_data <span class="ot">&lt;-</span> test_data <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state, type_test) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_n =</span> <span class="fu">sum</span>(n, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'state'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>grouped_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 168 × 3
# Groups:   state [56]
   state type_test   total_n
   &lt;chr&gt; &lt;chr&gt;         &lt;dbl&gt;
 1 AK    Antibody          0
 2 AK    Antigen           0
 3 AK    PCR        78690463
 4 AL    Antibody    6090878
 5 AL    Antigen           0
 6 AL    PCR               0
 7 AR    Antibody          0
 8 AR    Antigen     2261053
 9 AR    PCR       159758326
10 AS    Antibody          0
# ℹ 158 more rows</code></pre>
</div>
</div>
</section>
<section id="merging-data" class="level2">
<h2 class="anchored" data-anchor-id="merging-data">Merging data</h2>
<p>Now, we will practice how to merge different dataframes, by looking into the relationship between COVID-19 cases and deaths in counties and the proportion of black population based on the <a href="https://www.kaggle.com/datasets/muonneutrino/us-census-demographic-data">2017 US Census</a>. First, we will read the two datasets:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>county_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'./data/asec/us_counties_covid19_daily.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 800437 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): county, state
dbl  (3): fips, cases, deaths
date (1): date

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>census_2017 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'./data/asec/acs2017_county_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 3220 Columns: 37
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): State, County
dbl (35): CountyId, TotalPop, Men, Women, Hispanic, White, Black, Native, As...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p><code>county_data</code> contains information regarding daily cases and deaths per county in the US. First, we will get the total counts of both cases and deaths in 2020, grouping the information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>grouped_county <span class="ot">&lt;-</span> county_data <span class="sc">%&gt;%</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(county, state, fips) <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_cases =</span> <span class="fu">sum</span>(cases, <span class="at">na.rm =</span> T),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_deaths =</span> <span class="fu">sum</span>(deaths, <span class="at">na.rm =</span> T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'county', 'state'. You can override using
the `.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>grouped_county <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>total_cases)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,272 × 5
# Groups:   county, state [3,272]
   county        state       fips total_cases total_deaths
   &lt;chr&gt;         &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1 New York City New York      NA    56135658      5331870
 2 Los Angeles   California  6037    44307464      1102330
 3 Cook          Illinois   17031    29910215      1069364
 4 Miami-Dade    Florida    12086    26008017       476285
 5 Maricopa      Arizona     4013    22970785       489299
 6 Harris        Texas      48201    20161359       350475
 7 Dallas        Texas      48113    13506071       175342
 8 Broward       Florida    12011    11924547       208330
 9 Nassau        New York   36059    10754300       560451
10 Clark         Nevada     32003    10742491       210297
# ℹ 3,262 more rows</code></pre>
</div>
</div>
<p>Take a look at the census data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>census_2017</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,220 × 37
   CountyId State County TotalPop   Men  Women Hispanic White Black Native Asian
      &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1     1001 Alab… Autau…    55036 26899  28137      2.7  75.4  18.9    0.3   0.9
 2     1003 Alab… Baldw…   203360 99527 103833      4.4  83.1   9.5    0.8   0.7
 3     1005 Alab… Barbo…    26201 13976  12225      4.2  45.7  47.8    0.2   0.6
 4     1007 Alab… Bibb …    22580 12251  10329      2.4  74.6  22      0.4   0  
 5     1009 Alab… Bloun…    57667 28490  29177      9    87.4   1.5    0.3   0.1
 6     1011 Alab… Bullo…    10478  5616   4862      0.3  21.6  75.6    1     0.7
 7     1013 Alab… Butle…    20126  9416  10710      0.3  52.2  44.7    0.1   1.1
 8     1015 Alab… Calho…   115527 55593  59934      3.6  72.7  20.4    0.2   1  
 9     1017 Alab… Chamb…    33895 16320  17575      2.2  56.2  39.3    0.3   1  
10     1019 Alab… Chero…    25855 12862  12993      1.6  91.8   5      0.5   0.1
# ℹ 3,210 more rows
# ℹ 26 more variables: Pacific &lt;dbl&gt;, VotingAgeCitizen &lt;dbl&gt;, Income &lt;dbl&gt;,
#   IncomeErr &lt;dbl&gt;, IncomePerCap &lt;dbl&gt;, IncomePerCapErr &lt;dbl&gt;, Poverty &lt;dbl&gt;,
#   ChildPoverty &lt;dbl&gt;, Professional &lt;dbl&gt;, Service &lt;dbl&gt;, Office &lt;dbl&gt;,
#   Construction &lt;dbl&gt;, Production &lt;dbl&gt;, Drive &lt;dbl&gt;, Carpool &lt;dbl&gt;,
#   Transit &lt;dbl&gt;, Walk &lt;dbl&gt;, OtherTransp &lt;dbl&gt;, WorkAtHome &lt;dbl&gt;,
#   MeanCommute &lt;dbl&gt;, Employed &lt;dbl&gt;, PrivateWork &lt;dbl&gt;, PublicWork &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>The variables we want to keep are: <code>CountyId</code> (which is the same as the FIPS code seen in <code>county_data</code>), <code>TotalPop</code> and <code>Black</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>census_subset <span class="ot">&lt;-</span> census_2017 <span class="sc">%&gt;%</span> <span class="fu">select</span>(CountyId, TotalPop, Black)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can join the census data information with our COVID cases data, by FIPS code. Since some of the counties in our dataset do not contain this code, we will perform an <code>inner_join</code> in order to remove these cases. Of course, for a serious analysis, it would be necessary to check which counties are being ignored and what could be the consequences of this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>joined_county <span class="ot">&lt;-</span> grouped_county <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(census_subset, </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"fips"</span> <span class="ot">=</span> <span class="st">"CountyId"</span>))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>joined_county</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,212 × 7
# Groups:   county, state [3,212]
   county    state           fips total_cases total_deaths TotalPop Black
   &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
 1 Abbeville South Carolina 45001       89140         1853    24788  27.6
 2 Acadia    Louisiana      22001      470146        15640    62607  17.6
 3 Accomack  Virginia       51001      235243         3556    32840  28.3
 4 Ada       Idaho          16001     2148289        22346   435117   1.2
 5 Adair     Iowa           19001       20625          268     7192   0.3
 6 Adair     Kentucky       21001       71324         4544    19304   3.6
 7 Adair     Missouri       29001       70376           62    25437   2.4
 8 Adair     Oklahoma       40001      100180         1671    22136   0.3
 9 Adams     Colorado        8001     2028063        43638   487850   3  
10 Adams     Idaho          16003        6586          166     3946   0.3
# ℹ 3,202 more rows</code></pre>
</div>
</div>
<p>We want to look at the relationship between COVID cases and proportion of black population in each county. We can’t base this information on absolute number of cases. Counties with a larger population will contain a larger number of COVID cases, so we have to control this information by county. Although the data is from 2017, it is still an useful way to control the proportion of historically big and small counties.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>joined_county <span class="ot">&lt;-</span> joined_county <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cases_pop =</span> total_cases<span class="sc">/</span>TotalPop,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">deaths_pop =</span> total_deaths<span class="sc">/</span>TotalPop) </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>joined_county <span class="sc">%&gt;%</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>deaths_pop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,212 × 9
# Groups:   county, state [3,212]
   county         state   fips total_cases total_deaths TotalPop Black cases_pop
   &lt;chr&gt;          &lt;chr&gt;  &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
 1 Hancock        Georg… 13141       69015         7503     8667  72.9      7.96
 2 Randolph       Georg… 13243       63300         5957     7206  59.7      8.78
 3 Terrell        Georg… 13273       68844         6793     8978  60.6      7.67
 4 Early          Georg… 13099       94266         7263    10405  50.5      9.06
 5 Emporia city   Virgi… 51595       42697         3726     5495  64.3      7.77
 6 Galax city     Virgi… 51640       72124         4377     6788   7.2     10.6 
 7 McKinley       New M… 35031      869589        44943    72849   0.5     11.9 
 8 Neshoba        Missi… 28099      287790        18099    29437  20.9      9.78
 9 Essex          New J… 34013     4975781       454376   800401  38.8      6.22
10 East Feliciana Louis… 22037      220597        11087    19553  44.4     11.3 
# ℹ 3,202 more rows
# ℹ 1 more variable: deaths_pop &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Just by looking at this print of information, it appears that counties with a big proportion of black population had a bigger proportion of COVID deaths per capita. Let’s summarize this information to check:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>joined_county <span class="ot">&lt;-</span> joined_county <span class="sc">%&gt;%</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">black_categorical =</span> <span class="fu">case_when</span>(</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    Black <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">~</span> <span class="st">"Over 50% of the population is black"</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    Black <span class="sc">&lt;</span> <span class="dv">50</span> <span class="sc">~</span> <span class="st">"Under 50% of the population is black"</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>joined_county <span class="sc">%&gt;%</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(black_categorical) <span class="sc">%&gt;%</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_cases =</span> <span class="fu">median</span>(cases_pop, <span class="at">na.rm =</span> T),</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_deaths =</span> <span class="fu">median</span>(deaths_pop, <span class="at">na.rm =</span> T)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  black_categorical                    median_cases median_deaths
  &lt;chr&gt;                                       &lt;dbl&gt;         &lt;dbl&gt;
1 Over 50% of the population is black          6.40        0.173 
2 Under 50% of the population is black         2.90        0.0437</code></pre>
</div>
</div>
<p>With this information, we can see that racial disparities can be shown through Coronavirus data. These disparities were the result of pre-pandemic realities, of a social and economic structure of domination that has limited access to health and wealth for people of color.</p>
</section>
<section id="envisioning-information" class="level2">
<h2 class="anchored" data-anchor-id="envisioning-information">Envisioning information</h2>
<section id="the-basics-plot" class="level3">
<h3 class="anchored" data-anchor-id="the-basics-plot">The basics: plot()</h3>
<p>The basic function that comes with R base to make graphs is <code>plot()</code>. Its most basic functionality is to show all the relationship between all the variables of the dataframe with each other.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(census_subset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>However, as we might tell, this is not very useful to understand the information contained in the dataset when there are a lot of variables. To look into specific variables with different types of graphs, some parameters of the function must be modified. To do so, the variables that go into the x and y axis and the type of plot should be defined, as in the following example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> census_2017<span class="sc">$</span>Income, <span class="at">type =</span> <span class="st">"h"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In the <code>x</code> parameter, one can define the column that wants to be displayed as the independent variable. In this case, as we are showing a histogram, we do not need to define an y axis. The type of plot that shows the information is defined by the parameter <code>type</code>. If we defined another type of plot, for example, a scatter plot to see the relationship between the proportion of hispanic population and income, we should set this parameter to “p”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> census_2017<span class="sc">$</span>Hispanic, <span class="at">y =</span> census_2017<span class="sc">$</span>IncomePerCap, <span class="at">type =</span> <span class="st">"p"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>While <code>plot()</code> is a function that works correctly, and with only a few lines of code does the job necessary to show information, it is not the best way to show data in a visually appealing way. It does not allow us to easily map values as aesthetic attributes, which makes it hard to add more than one layer of information. In the following section, we will introduce the package used by excellence in the R community to make graphs.</p>
</section>
<section id="reloaded-plots-with-ggplot" class="level3">
<h3 class="anchored" data-anchor-id="reloaded-plots-with-ggplot">Reloaded plots with ggplot</h3>
<p><code>ggplot2</code> is the most popular data visualization package to use in R. It is included in the <code>tidyverse</code> package, and even the <a href="https://medium.com/bbc-visual-and-data-journalism/how-the-bbc-visual-and-data-journalism-team-works-with-graphics-in-r-ed0b35693535">BBC uses it to make graphs</a> displayed in the journal. The reason why it’s so successful and popular is because the logic behind the syntaxis and functionality of this package is the previously mentioned <strong>Grammar of Graphics</strong>. The elements of the graph are incorporated as layers, which makes developing charts structural and effusive.</p>
<p>Let’s dive into the functionality of <code>ggplot()</code>. First, the library should be imported.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, remember that this package is also included in the tidyverse! Therefore, if we import <code>tidyverse</code> package, there is no need to import <code>ggplot2</code> as well.</p>
<section id="basic-usage" class="level4">
<h4 class="anchored" data-anchor-id="basic-usage">Basic usage</h4>
<p>The most simple case of use of a ggplot graph is the following:</p>
<ul>
<li>calling the function <code>ggplot()</code>, inputing a dataset and an aesthetic mapping with <code>aes()</code></li>
<li>a ‘geom’ layer, which defines the type of graph that will show the data.</li>
</ul>
<p>For example, if we wanted to replicate the previous scatter plot, we should do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(census_2017, <span class="fu">aes</span>(<span class="at">x =</span> Hispanic, <span class="at">y =</span> IncomePerCap))<span class="sc">+</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Easy! If we wanted to change the scatter plot into a line plot, we should only replace <code>geom_point()</code> with <code>geom_line()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(census_2017, <span class="fu">aes</span>(<span class="at">x =</span> Hispanic, <span class="at">y =</span> IncomePerCap))<span class="sc">+</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Line plots and scatter plots are the easiest way to show the relationship between two continuous variables in a graph. To show categorical values, we will likely use the geometeries geom_bar() or geom_col() to make barplots. What is the difference between those two?</p>
<p>Let’s look into it with an example. We can show the count of counties by state in the 2017 census in the following way:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(census_2017, <span class="fu">aes</span>(<span class="at">y =</span> State))<span class="sc">+</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The function <code>geom_bar()</code> automatically counts all the observations per group in the selected variable for ‘x’ and displays them in bars. Therefore, there is no need to define a variable for the ‘y’ axis. However, if we wanted to show the numerical values of groups we would not be able to do so with this geometry. In this case, we would need to use <code>geom_col()</code>.</p>
<p>Let’s look at this with an example visualizing the poverty for all the counties in the state of Alabama. Note that we can also combine tidyverse with ggplot syntax.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>census_2017 <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(State <span class="sc">==</span> <span class="st">'Alabama'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> County, <span class="at">x =</span> Poverty)) <span class="sc">+</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The bars can also be sorted using the function <code>reorder()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>census_2017 <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(State <span class="sc">==</span> <span class="st">'Alabama'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(County, Poverty), <span class="at">x =</span> Poverty)) <span class="sc">+</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These are the most common geometries used to show categorical and continuous information. However, remember that during the theoretical exposition of the class we also presented some graphs that show the distribution of variables in a dataset. We went over histograms (<code>geom_histogram()</code>), density graphs (<code>geom_smooth()</code>), and boxplots (<code>geom_boxplot()</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(census_2017, <span class="fu">aes</span>(<span class="at">y =</span> Poverty))<span class="sc">+</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For these kind of plots, we follow the same logic of only passing one variable as y or x. The other axis will automatically be plotted according to the kind of distribution for the geom.</p>
<p>Finally, while geographical data is beyond the scope of this class, it is important to note that it is possible to make maps with ggplot, using the geometry <code>geom_sf()</code>.</p>
</section>
<section id="mapping-more-aesthetic-attributes" class="level4">
<h4 class="anchored" data-anchor-id="mapping-more-aesthetic-attributes">Mapping more aesthetic attributes</h4>
<p>So far, we have only worked with the parameters x and y to map variables into axis. However, we can also map variables as <em>color</em>, <em>shapes</em> and <em>sizes</em>. All these options can be controlled through parameters in the function <code>aes()</code>.</p>
<p>Recall the plot that showed the level of poverty in counties in Alabama. We could also show the percentage of white population for each of these counties, coloring the bars. To do so, we should set the parameter <code>fill</code> to the variable <code>White</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>census_2017 <span class="sc">%&gt;%</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(State <span class="sc">==</span> <span class="st">'Alabama'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(County, Poverty), <span class="at">x =</span> Poverty, <span class="at">fill =</span> White)) <span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It appears that counties with higher proportions of non-white population have higher levels of poverty.</p>
<p><code>aes()</code> also contains the parameter <code>color</code> to map a variable as colors in a graph. However, look at what would happen if we used it in this bar plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>census_2017 <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(State <span class="sc">==</span> <span class="st">'Alabama'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(County, Poverty), <span class="at">x =</span> Poverty, <span class="at">color =</span> White)) <span class="sc">+</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Only the borders of the bars were colored! This is because <code>color</code> is used to color lines and points. This is why we only use it to color scatter plots, line plots, or the outlines of box plots. Take a look at how the previous example of the relationship between income and percentage of hispanic population looks like when we introduce the states in the scatter plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(census_2017, <span class="fu">aes</span>(<span class="at">x =</span> Hispanic, <span class="at">y =</span> IncomePerCap, <span class="at">color =</span> State))<span class="sc">+</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It’s crucial to recognize that, in this instance, this plot isn’t the most suitable choice for representing the data. Since there are multiple many states painted in different colors, the graph is mostly taken by the labels of the states. Often, when we introduce additional aesthetic elements into a graph, it necessitates adjustments to ensure a cohesive presentation of all the new layers of information.</p>
<p>The appearance of the color in the plot can also be modified. Look at the distribution of cases in the population for counties with a high proportion of black population and counties with less than 50% black population.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(joined_county, <span class="fu">aes</span>(<span class="at">x =</span> cases_pop, <span class="at">fill =</span> black_categorical))<span class="sc">+</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can modify the <code>alpha</code> parameter of the density plot to fine-tune the transparency of the areas and enhance the clarity of the displayed information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(joined_county, <span class="fu">aes</span>(<span class="at">x =</span> cases_pop, <span class="at">fill =</span> black_categorical))<span class="sc">+</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These aesthetic attributes can be used as well as fixed parameters for a geom; that is, not changing according to the values of a variable, but remaining the same for all plotted figures. This is achieved by defining a specific value, and outside the call to <code>aes()</code>. For example, using <code>color = "blue"</code> instead of assigning a variable, such as <code>aes(color = black_categorical)</code>. Note the difference: inside the <code>aes()</code> function, we do not define specific colors, ggplot takes care of that. We just state the column that we want to map into the plot as colors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(census_2017, <span class="fu">aes</span>(<span class="at">y =</span> Poverty))<span class="sc">+</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>( <span class="at">color =</span> <span class="st">'navyblue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>R also contains many packages with color palettes that can be used in plots. The most popular one is <code>viridis</code>. The color palettes in <code>viridis</code> can be easily added with one line of code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: viridisLite</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>census_2017 <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(State <span class="sc">==</span> <span class="st">'Alabama'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(County, Poverty), <span class="at">x =</span> Poverty, <span class="at">fill =</span> White)) <span class="sc">+</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="control-variables" class="level4">
<h4 class="anchored" data-anchor-id="control-variables">Control variables</h4>
<p>Another technique for displaying additional categorical variables on a plot is faceting. It involves partitioning the data into subsets and presenting the same graph for each subset, effectively generating tables of graphics. Small multiples, as a result, prove to be a valuable asset for exploratory data analysis. They enable swift comparisons of patterns across various data segments, facilitating the assessment of similarities and differences.</p>
<p>The <code>facet_wrap()</code> function organizes a long strip of panels, which can be generated by any number of variables, into a two-dimensional format. This proves especially handy when dealing with a single variable that has numerous levels and we aim to arrange the plots in a more space-efficient fashion.</p>
<p>We have the ability to manage how the strip is transformed into a grid using parameters such as <code>ncol</code>, <code>nrow</code>, <code>as.table</code>, and <code>dir.</code></p>
<ul>
<li><code>ncol</code> and <code>nrow</code> determine the number of columns and rows in the grid (we only need to specify one of them).</li>
<li><code>as.table</code> dictates whether the facets should be laid out in a table-like fashion (TRUE), where higher values are positioned at the bottom-right, or in a plot-oriented manner (FALSE), with higher values placed at the top-right.</li>
<li><code>dir</code> allows us to choose the direction of wrapping, whether it’s horizontal or vertical.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(joined_county, <span class="fu">aes</span>(<span class="at">x =</span> cases_pop))<span class="sc">+</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()<span class="sc">+</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>black_categorical, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can influence whether the position scales are consistent across all panels (fixed) or permitted to differ between panels (free) by utilizing the “scales” parameter in various ways:</p>
<ul>
<li><code>scales = "fixed"</code>: This setting ensures that both the x and y scales are consistent and identical across all panels.</li>
<li><code>scales = "free_x"</code>: In this scenario, the x scale is free to vary between panels, while the y scale remains fixed and consistent across all panels.</li>
<li><code>scales = "free_y"</code>: Here, the y scale is allowed to vary independently between panels, while the x scale remains fixed and consistent.</li>
<li><code>scales = "free"</code>: In this case, both the x and y scales are free to vary between panels, enabling each panel to have its unique scaling.</li>
</ul>
</section>
<section id="polishing-graphs" class="level4">
<h4 class="anchored" data-anchor-id="polishing-graphs">Polishing graphs</h4>
<p>In the context of data exploration, the important thing is to work quickly. We try one or another visualization technique and refine our results until we find interesting patterns, or get our doubts about the content out of our minds. We don’t need to title the visualizations, because we already know what they are about (we just wrote them down!). We don’t worry that the names of the axes clearly indicate the variable they represent, because we already know beforehand.</p>
<p>But when we want to save a graph to share with others, either by publishing it in a paper or emailing it to colleagues, we need to be more careful. We have moved from the realm of exploration to the realm of communication. Now we do care about clarity, because we don’t know in advance how familiar the eventual audience is with the data.</p>
<p>Although clear communication is an art whose rules depend on the context, and everyone has their own style, we can mention at least three elements that should not be missing in a graphic designed to be shared:</p>
<ul>
<li>A descriptive, but brief title.</li>
<li>Clear (not ambiguous) labels on the axes.</li>
<li>Descriptive names in the legends</li>
</ul>
<p>and while we’re at it, two optional ones:</p>
<ul>
<li>A subtitle where to put important details that do not fit in a brief title.</li>
<li>A footnote with additional information: source of the data, academic citation, warnings, etc.</li>
</ul>
<p>All of this can be done using the function <code>labs()</code>. Its usage is really simple: it is only neccesary to modify the parameters that have the name of the label one wants to change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>census_2017 <span class="sc">%&gt;%</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(State <span class="sc">==</span> <span class="st">'Alabama'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(County, Poverty), <span class="at">x =</span> Poverty, <span class="at">fill =</span> White)) <span class="sc">+</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>()<span class="sc">+</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Poverty and racism in Alabama'</span>,</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'year: 2017'</span>,</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">'Source: US Census'</span>,</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'% of poor population'</span>,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">''</span>,</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">'% of white population'</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So far we have been able to adjust the graphic attributes that are closely related to the data, such as scales, colors and sizes, but what about other visual components that we could change, such as text size, font, background colors, grid lines, and more. Some common elements that we can control using themes in ggplot2:</p>
<ol type="1">
<li><p>Axis Text: We can modify the appearance of axis labels, titles, and text.</p></li>
<li><p>Plot Title: Customize the title of our plot.</p></li>
<li><p>Background: Adjust the plot’s background color.</p></li>
<li><p>Grid Lines: Control the visibility and appearance of grid lines.</p></li>
<li><p>Legend: Modify the appearance of the legend, including its position, background, and text.</p></li>
<li><p>Facets: Customize the appearance of facets (if our plot uses them).</p></li>
</ol>
<p>We can change the theme of our ggplot2 plot using the <code>theme()</code> function. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>census_2017 <span class="sc">%&gt;%</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(State <span class="sc">==</span> <span class="st">'Alabama'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(County, Poverty), <span class="at">x =</span> Poverty, <span class="at">fill =</span> White)) <span class="sc">+</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>()<span class="sc">+</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Poverty and racism in Alabama'</span>,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'year: 2017'</span>,</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">'Source: US Census'</span>,</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'% of poor population'</span>,</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">''</span>,</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">'% of white population'</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">+</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">text=</span><span class="fu">element_text</span>(<span class="at">family=</span><span class="st">"serif"</span>)</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ggplot2 package includes several functions that apply predefined themes, such as <code>theme_dark()</code>, <code>theme_void</code>, <code>theme_minimal</code>, etc. Therefore, to use the themes it is enough to add a line that calls the corresponding function. For example, to use <code>theme_minimal()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>census_2017 <span class="sc">%&gt;%</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(State <span class="sc">==</span> <span class="st">'Alabama'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(County, Poverty), <span class="at">x =</span> Poverty, <span class="at">fill =</span> White)) <span class="sc">+</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>()<span class="sc">+</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Poverty and racism in Alabama'</span>,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'year: 2017'</span>,</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">'Source: US Census'</span>,</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'% of poor population'</span>,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">''</span>,</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">'% of white population'</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">+</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_guided_practice_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There are also R packages that add new ready-to-use themes to our toolbox, such as <a href="https://yutannihilation.github.io/allYourFigureAreBelongToUs/ggthemes/"><code>ggthemes</code></a> and <a href="https://cinc.rud.is/web/packages/hrbrthemes/"><code>hrbrthemes</code></a>.</p>
<p><code>ggplot</code> package offers numerous functions for tailoring plots. The <a href="https://www.maths.usyd.edu.au/u/UG/SM/STAT3022/r/current/Misc/data-visualization-2.1.pdf">cheat sheet</a> serves as a comprehensive guide to the various customization options, while the <a href="https://r-graph-gallery.com/">R Graph Gallery</a> showcases a variety of charts created using the package, serving as a valuable source of inspiration. For a more thorough understanding of the graphs, Claus O. Wilke’s book ‘Fundamentals of Data Visualization’ features an extensive chapter titled <a href="https://clauswilke.com/dataviz/directory-of-visualizations.html">‘Directory of Visualizations.’</a></p>
<p>We can save the result plots by using the function <code>ggsave()</code>. The parameters we must pass by to successfully save the plot are the filename, which should be the name we want to create on disk, and optionally the plot to save. If nothing is defined, it just saves the last plot displayed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">'plot_01.jpg'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>In parsing, <strong>code is taken from the preprocessor, broken into smaller pieces and analyzed so other software can understand it</strong>. The parser does this by building a data structure out of the pieces of input.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>